{% extends 'books/base.html' %}

{% block title %}{{ book.title }} - EmoArc{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
        <a href="{% url 'books:home' %}" class="text-purple-600 hover:text-purple-800">Library</a>
        <span class="mx-2 text-gray-400">/</span>
        <span class="text-gray-600">{{ book.title }}</span>
    </nav>

    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ book.title }}</h1>
                <p class="text-xl text-gray-600 mb-4">by {{ book.author }}</p>

                <div class="flex items-center gap-3 mb-4">
                    {% if book.primary_genre %}
                    <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                        {{ book.primary_genre }}
                    </span>
                    {% endif %}
                    <span class="text-sm text-gray-500">Book ID: {{ book.book_id }}</span>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-4 gap-4 mt-6">
                    <div class="border-l-4 border-green-500 pl-4">
                        <div class="text-2xl font-bold text-gray-900">{{ book.avg_valence|floatformat:2 }}</div>
                        <div class="text-sm text-gray-600">Valence</div>
                        <div class="text-xs text-gray-500">Overall positivity</div>
                    </div>
                    <div class="border-l-4 border-amber-500 pl-4">
                        <div class="text-2xl font-bold text-gray-900">{{ book.avg_arousal|floatformat:2 }}</div>
                        <div class="text-sm text-gray-600">Arousal</div>
                        <div class="text-xs text-gray-500">Emotional intensity</div>
                    </div>
                    <div class="border-l-4 border-purple-500 pl-4">
                        <div class="text-2xl font-bold text-gray-900">{{ book.avg_dominance|floatformat:2 }}</div>
                        <div class="text-sm text-gray-600">Dominance</div>
                        <div class="text-xs text-gray-500">Control/Power</div>
                    </div>
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="text-2xl font-bold text-gray-900">{{ book.emotional_volatility|floatformat:2 }}</div>
                        <div class="text-sm text-gray-600">Volatility</div>
                        <div class="text-xs text-gray-500">Emotional variation</div>
                    </div>
                </div>
            </div>

            <div>
                <a href="{% url 'books:recommendations' book.book_id %}"
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700">
                    Get Recommendations
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Emotion Radar Chart -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Emotion Profile</h2>
                <div id="radar-chart"></div>
            </div>

            <!-- Emotion Trajectory -->
            {% if trajectory_chart %}
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Emotional Journey</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Track how emotions evolve throughout the narrative
                </p>
                <div id="trajectory-chart"></div>
            </div>
            {% endif %}

            <!-- VAD Chart -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Emotional Dimensions (VAD)</h2>
                <div id="vad-chart"></div>
                <div class="mt-4 space-y-2 text-sm text-gray-600">
                    <p><strong>Valence:</strong> How positive or negative the emotional tone is</p>
                    <p><strong>Arousal:</strong> The intensity or activation level of emotions</p>
                    <p><strong>Dominance:</strong> Sense of control or power in the narrative</p>
                </div>
            </div>

            <!-- Narrative Arc -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Narrative Structure</h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Rising Action</span>
                            <span class="text-gray-600">{{ book.rising_action_pct|floatformat:1 }}%</span>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-400 to-blue-600"
                                 style="width: {{ book.rising_action_pct }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Climax Position</span>
                            <span class="text-gray-600">{{ book.climax_position|floatformat:1 }}%</span>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-red-400 to-red-600"
                                 style="width: {{ book.climax_position }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Resolution</span>
                            <span class="text-gray-600">{{ book.resolution_pct|floatformat:1 }}%</span>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-green-400 to-green-600"
                                 style="width: {{ book.resolution_pct }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topic Summary -->
            {% if book.topic_summary %}
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Thematic Content</h2>
                <p class="text-gray-700 mb-4">{{ book.topic_summary }}</p>

                {% if book.dominant_themes %}
                <div class="space-y-3">
                    <h3 class="font-semibold text-gray-900">Dominant Themes:</h3>
                    {% for theme in book.dominant_themes %}
                    <div class="border-l-4 border-purple-500 pl-4">
                        <div class="flex justify-between items-start">
                            <div class="font-medium text-gray-900">{{ theme.theme }}</div>
                            <div class="text-sm text-purple-600 font-medium">{{ theme.probability|floatformat:1 }}%</div>
                        </div>
                        {% if theme.top_words %}
                        <div class="text-sm text-gray-600 mt-1">
                            {{ theme.top_words|join:", " }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Top Emotions -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Top Emotions</h2>
                <div class="space-y-3">
                    {% for emotion, value in top_emotions %}
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700 capitalize">{{ emotion }}</span>
                            <span class="text-gray-600">{{ value|floatformat:3 }}</span>
                        </div>
                        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500"
                                 style="width: {{ value|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Top Emotional Dyads -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Complex Emotions</h2>
                <p class="text-xs text-gray-500 mb-3">Plutchik's emotional dyads</p>
                <div class="space-y-2">
                    {% for dyad, value in top_dyads %}
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-medium text-gray-700 capitalize">{{ dyad }}</span>
                        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">
                            {{ value|floatformat:3 }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Similar Books -->
            {% if similar_books %}
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Similar Books</h2>
                <p class="text-xs text-gray-500 mb-3">Based on emotional similarity</p>
                <div class="space-y-3">
                    {% for similar in similar_books %}
                    <a href="{% url 'books:book_detail' similar.book_id %}"
                       class="block p-3 rounded-lg hover:bg-gray-50 transition">
                        <div class="font-medium text-sm text-gray-900 line-clamp-2">{{ similar.title }}</div>
                        <div class="text-xs text-gray-600 mt-1">{{ similar.author }}</div>
                        {% if similar.primary_genre %}
                        <span class="inline-block mt-2 px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full">
                            {{ similar.primary_genre }}
                        </span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Render Plotly charts
    const radarChart = {{ radar_chart|safe }};
    Plotly.newPlot('radar-chart', radarChart.data, radarChart.layout, {responsive: true, displayModeBar: false});

    {% if trajectory_chart %}
    const trajectoryChart = {{ trajectory_chart|safe }};
    Plotly.newPlot('trajectory-chart', trajectoryChart.data, trajectoryChart.layout, {responsive: true, displayModeBar: false});
    {% endif %}

    const vadChart = {{ vad_chart|safe }};
    Plotly.newPlot('vad-chart', vadChart.data, vadChart.layout, {responsive: true, displayModeBar: false});
</script>
{% endblock %}
